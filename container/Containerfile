# Build stage - native compilation per platform
FROM rust:1.93.1-alpine3.23  AS builder

# Install build dependencies
# hadolint ignore=DL3018
RUN apk add --no-cache \
    musl-dev \
    pkgconfig \
    openssl-dev \
    protobuf-dev

WORKDIR /build

# Copy manifest files
COPY Cargo.toml Cargo.lock ./
COPY build.rs ./
COPY api.proto ./

# Copy source code
COPY src ./src

# Build the application natively for the target platform
RUN cargo build --release

# Runtime stage
FROM alpine:3.23

# Install CA certificates for HTTPS requests
# hadolint ignore=DL3018
RUN apk add --no-cache ca-certificates

WORKDIR /app

# Copy the binary from builder
COPY --from=builder /build/target/release/nest-sync /app/nest-sync

# Create directory for video output
RUN mkdir -p /app/videos

# Set environment variables (can be overridden at runtime)
ENV RUST_LOG=info

# Run the application
ENTRYPOINT ["/app/nest-sync"]
CMD ["--output", "/app/videos"]
